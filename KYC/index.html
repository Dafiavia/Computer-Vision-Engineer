<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Verification System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner {
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 2px solid #fff;
            width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Animasi halus */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Styling agar gambar pas di dalam box */
        .preview-img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain; /* Agar gambar tidak gepeng */
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12">

    <nav class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-1.5 rounded-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 leading-tight">KYC Verification System</h1>
                        <p class="text-xs text-slate-500">Sistem Verifikasi Identitas Digital</p>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 space-y-6">

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <span class="bg-indigo-50 text-indigo-700 font-bold px-2.5 py-1 rounded-md text-sm">1</span>
                <h2 class="text-lg font-semibold text-slate-800">Registrasi ID Card</h2>
            </div>
            <div class="p-6">
                <div class="relative w-full h-64 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 hover:bg-slate-100 hover:border-indigo-400 transition cursor-pointer flex justify-center items-center overflow-hidden" onclick="document.getElementById('file-id').click()">
                    
                    <input type="file" id="file-id" class="hidden" accept="image/*" onchange="previewImage(this, 'preview-id-img', 'placeholder-id')">
                    
                    <div id="placeholder-id" class="text-center space-y-2 p-4">
                        <div class="mx-auto bg-indigo-100 w-12 h-12 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        </div>
                        <p class="text-sm font-medium text-slate-700">Klik untuk upload ID Card</p>
                        <p class="text-xs text-slate-500">(Klik lagi untuk mengganti foto)</p>
                    </div>

                    <img id="preview-id-img" class="hidden preview-img z-10" src="">
                </div>

                <div id="result-id" class="mt-4 hidden bg-slate-50 rounded-lg p-4 border border-slate-200">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><p class="text-xs text-slate-500">NIK</p><p id="res-id-number" class="font-medium font-mono text-indigo-700">--</p></div>
                        <div><p class="text-xs text-slate-500">Nama</p><p id="res-id-name" class="font-medium">--</p></div>
                        <div><p class="text-xs text-slate-500">Tgl Lahir</p><p id="res-id-dob" class="font-medium">--</p></div>
                        <div><p class="text-xs text-slate-500">Validitas</p><span id="res-id-valid" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100">--</span></div>
                    </div>
                </div>

                <div id="msg-id" class="mt-4 hidden rounded-lg p-3 text-sm fade-in"></div>

                <button onclick="submitIdCard()" id="btn-submit-id" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-xl transition shadow-lg shadow-indigo-200 flex justify-center items-center">
                    Submit ID Card
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" id="card-step-2">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <span class="bg-emerald-50 text-emerald-700 font-bold px-2.5 py-1 rounded-md text-sm">2</span>
                <h2 class="text-lg font-semibold text-slate-800">Registrasi Wajah</h2>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">ID Number</label>
                    <input type="text" id="input-face-id" class="w-full bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block p-2.5" placeholder="Masukkan ID Number (cth: 12345678X)">
                </div>
                
                <div class="relative w-full h-64 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 hover:bg-slate-100 hover:border-emerald-400 transition cursor-pointer flex justify-center items-center overflow-hidden" onclick="document.getElementById('file-face').click()">
                    
                    <input type="file" id="file-face" class="hidden" accept="image/*" onchange="previewImage(this, 'preview-face-img', 'placeholder-face')">
                    
                    <div id="placeholder-face" class="text-center space-y-2 p-4">
                        <div class="mx-auto bg-emerald-100 w-12 h-12 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <p class="text-sm font-medium text-slate-700">Klik untuk upload wajah</p>
                    </div>

                    <img id="preview-face-img" class="hidden preview-img z-10" src="">
                </div>

                <div id="msg-face" class="mt-4 hidden rounded-lg p-3 text-sm fade-in"></div>

                <button onclick="submitFace()" id="btn-submit-face" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-xl transition shadow-lg shadow-indigo-200 flex justify-center items-center">
                    Submit Wajah
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden" id="card-step-3">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <span class="bg-amber-50 text-amber-700 font-bold px-2.5 py-1 rounded-md text-sm">3</span>
                <h2 class="text-lg font-semibold text-slate-800">Verifikasi KYC</h2>
            </div>
            <div class="p-6">
                
                <div class="relative w-full h-72 border-2 border-dashed border-slate-300 rounded-xl bg-slate-50 hover:bg-slate-100 hover:border-amber-400 transition cursor-pointer flex justify-center items-center overflow-hidden" onclick="document.getElementById('file-kyc').click()">
                    
                    <input type="file" id="file-kyc" class="hidden" accept="image/*" onchange="previewImage(this, 'preview-kyc-img', 'placeholder-kyc', 'canvas-kyc')">
                    
                    <div id="placeholder-kyc" class="text-center space-y-2 p-4">
                        <div class="mx-auto bg-amber-100 w-12 h-12 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                        </div>
                        <p class="text-sm font-medium text-slate-700">Klik untuk upload foto verifikasi</p>
                    </div>

                    <div class="relative h-full w-full flex justify-center items-center">
                        <img id="preview-kyc-img" class="hidden preview-img z-10" src="">
                        <canvas id="canvas-kyc" class="absolute top-0 left-0 w-full h-full z-20 pointer-events-none hidden"></canvas>
                    </div>
                </div>

                <div id="result-kyc" class="mt-4 hidden">
                    <div class="p-4 rounded-lg border flex flex-col items-center justify-center text-center space-y-2" id="kyc-status-box">
                        <div class="text-2xl font-bold" id="kyc-match-status">MATCHED</div>
                        <div class="text-sm text-slate-600">Score: <span id="kyc-score" class="font-mono font-bold">--</span></div>
                    </div>
                    <div id="kyc-user-details" class="mt-4 bg-slate-50 rounded-lg p-4 border border-slate-200 hidden">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Data Pengguna (Database)</h3>
                        <ul class="text-sm space-y-2">
                            <li class="flex justify-between border-b pb-1"><span class="text-slate-500">Nama:</span> <span id="kyc-db-name" class="font-medium text-right"></span></li>
                            <li class="flex justify-between border-b pb-1"><span class="text-slate-500">ID:</span> <span id="kyc-db-id" class="font-mono text-right"></span></li>
                            <li class="flex justify-between border-b pb-1"><span class="text-slate-500">DOB:</span> <span id="kyc-db-dob" class="text-right"></span></li>
                        </ul>
                    </div>
                </div>

                <div id="msg-kyc" class="mt-4 hidden rounded-lg p-3 text-sm fade-in"></div>

                <button onclick="verifyKYC()" id="btn-submit-kyc" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-xl transition shadow-lg shadow-indigo-200 flex justify-center items-center">
                    Verifikasi KYC
                </button>
            </div>
        </div>

    </main>

    <script>
        const API_URL = "http://127.0.0.1:8000";

        // --- HELPER FUNCTIONS ---

        function showMessage(elementId, type, text) {
            const el = document.getElementById(elementId);
            el.className = `mt-4 rounded-lg p-3 text-sm fade-in ${
                type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' :
                type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' :
                'bg-yellow-50 text-yellow-700 border border-yellow-200'
            }`;
            el.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${text}`;
            el.classList.remove('hidden');
        }

        // Fungsi Preview Image Baru: Mengganti Placeholder dengan Gambar
        function previewImage(input, imgId, placeholderId, canvasId = null) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById(imgId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    
                    // Sembunyikan Placeholder Icon
                    document.getElementById(placeholderId).classList.add('hidden');
                    
                    // Reset UI Khusus KYC
                    if(canvasId) {
                        const canvas = document.getElementById(canvasId);
                        canvas.classList.remove('hidden'); // Tampilkan canvas layer
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height); // Bersihkan gambar box lama
                        
                        document.getElementById('result-kyc').classList.add('hidden');
                        document.getElementById('msg-kyc').classList.add('hidden');
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        function setLoading(btnId, isLoading, text) {
            const btn = document.getElementById(btnId);
            if(isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<span class="spinner"></span> Memproses...`;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
            } else {
                btn.disabled = false;
                btn.innerHTML = text;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }

        // --- STEP 1: ID CARD ---
        async function submitIdCard() {
            const fileInput = document.getElementById('file-id');
            if(!fileInput.files[0]) return showMessage('msg-id', 'error', "Pilih file ID Card dulu!");

            setLoading('btn-submit-id', true);
            document.getElementById('msg-id').classList.add('hidden');

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            try {
                const res = await fetch(`${API_URL}/register-idcard`, { method: 'POST', body: formData });
                const data = await res.json();

                if(data.status === 'success' || data.status === 'failed') {
                    const info = data.data;
                    document.getElementById('res-id-number').innerText = info.id_number || "Tidak terdeteksi";
                    document.getElementById('res-id-name').innerText = info.full_name || "Tidak terdeteksi";
                    document.getElementById('res-id-dob').innerText = info.dob || "Tidak terdeteksi";
                    
                    const validBadge = document.getElementById('res-id-valid');
                    validBadge.innerText = info.id_valid ? "VALID" : "INVALID";
                    validBadge.className = `inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${info.id_valid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                    
                    document.getElementById('result-id').classList.remove('hidden');
                    
                    if(info.id_number) {
                        document.getElementById('input-face-id').value = info.id_number;
                    }

                    if (data.message.includes("Warning")) showMessage('msg-id', 'warning', data.message);
                    else showMessage('msg-id', 'success', data.message);

                } else {
                    showMessage('msg-id', 'error', data.message);
                }
            } catch (err) {
                showMessage('msg-id', 'error', "Gagal koneksi: " + err);
            } finally {
                setLoading('btn-submit-id', false, "Submit ID Card");
            }
        }

        // --- STEP 2: REGISTER FACE ---
        async function submitFace() {
            const fileInput = document.getElementById('file-face');
            const idNumber = document.getElementById('input-face-id').value;

            if(!fileInput.files[0]) return showMessage('msg-face', 'error', "Pilih foto wajah dulu!");
            if(!idNumber) return showMessage('msg-face', 'error', "ID Number wajib diisi!");

            setLoading('btn-submit-face', true);
            document.getElementById('msg-face').classList.add('hidden');

            const formData = new FormData();
            formData.append('id_number', idNumber);
            formData.append('image', fileInput.files[0]);

            try {
                const res = await fetch(`${API_URL}/register-face`, { method: 'POST', body: formData });
                const data = await res.json();

                if(data.status === 'success') {
                    showMessage('msg-face', 'success', data.message);
                } else {
                    showMessage('msg-face', 'error', data.message);
                }
            } catch (err) {
                showMessage('msg-face', 'error', "Error: " + err);
            } finally {
                setLoading('btn-submit-face', false, "Submit Wajah");
            }
        }

        // --- STEP 3: KYC CHECK ---
        async function verifyKYC() {
            const fileInput = document.getElementById('file-kyc');
            if(!fileInput.files[0]) return showMessage('msg-kyc', 'error', "Pilih foto verifikasi!");

            setLoading('btn-submit-kyc', true);
            document.getElementById('msg-kyc').classList.add('hidden');
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            try {
                const res = await fetch(`${API_URL}/kyc-check`, { method: 'POST', body: formData });
                const data = await res.json();

                if(data.status === 'success') {
                    // Gambar Box
                    const img = document.getElementById('preview-kyc-img');
                    const canvas = document.getElementById('canvas-kyc');
                    if(data.face_bbox) drawBox(img, canvas, data.face_bbox);

                    document.getElementById('result-kyc').classList.remove('hidden');
                    document.getElementById('kyc-score').innerText = data.similarity_score;

                    const statusBox = document.getElementById('kyc-status-box');
                    const matchText = document.getElementById('kyc-match-status');

                    if(data.match) {
                        matchText.innerText = "MATCHED";
                        statusBox.className = "p-4 rounded-lg border flex flex-col items-center justify-center text-center space-y-2 bg-green-50 border-green-200 text-green-700";
                        if(data.user_details) {
                            document.getElementById('kyc-user-details').classList.remove('hidden');
                            document.getElementById('kyc-db-name').innerText = data.user_details.full_name || "-";
                            document.getElementById('kyc-db-id').innerText = data.user_details.id_number || "-";
                            document.getElementById('kyc-db-dob').innerText = data.user_details.dob || "-";
                        }
                        showMessage('msg-kyc', 'success', "Verifikasi Berhasil!");
                    } else {
                        matchText.innerText = "NOT MATCHED";
                        statusBox.className = "p-4 rounded-lg border flex flex-col items-center justify-center text-center space-y-2 bg-red-50 border-red-200 text-red-700";
                        document.getElementById('kyc-user-details').classList.add('hidden');
                        showMessage('msg-kyc', 'warning', "Wajah tidak cocok dengan database.");
                    }
                } else {
                    showMessage('msg-kyc', 'error', data.message);
                }
            } catch (err) {
                showMessage('msg-kyc', 'error', "Error: " + err);
            } finally {
                setLoading('btn-submit-kyc', false, "Verifikasi KYC");
            }
        }

        function drawBox(img, canvas, bbox) {
            const ctx = canvas.getContext('2d');
            
            // Set ukuran canvas sama persis dengan ukuran render gambar
            canvas.width = img.clientWidth;
            canvas.height = img.clientHeight;

            // Hitung rasio (Rendered size vs Original size)
            const scaleX = img.clientWidth / img.naturalWidth;
            const scaleY = img.clientHeight / img.naturalHeight;

            const [x1, y1, x2, y2] = bbox;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = "#00FF00"; // Warna Hijau Neon
            
            // Gambar persegi
            ctx.rect(x1 * scaleX, y1 * scaleY, (x2 - x1) * scaleX, (y2 - y1) * scaleY);
            ctx.stroke();
        }
    </script>
</body>
</html>